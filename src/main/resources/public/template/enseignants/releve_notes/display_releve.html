<!--
  ~ Copyright (c) Région Hauts-de-France, Département de la Seine-et-Marne, CGI, 2016.
  ~     This file is part of OPEN ENT NG. OPEN ENT NG is a versatile ENT Project based on the JVM and ENT Core Project.
  ~
  ~   This program is free software; you can redistribute it and/or modify
  ~   it under the terms of the GNU Affero General Public License as
  ~   published by the Free Software Foundation (version 3 of the License).
  ~   For the sake of explanation, any module that communicate over native
  ~   Web protocols, such as HTTP, with OPEN ENT NG is outside the scope of this
  ~   license and could be license under its own terms. This is merely considered
  ~   normal use of OPEN ENT NG, and does not fall under the heading of "covered work".
  ~
  ~   This program is distributed in the hope that it will be useful,
  ~   but WITHOUT ANY WARRANTY; without even the implied warranty of
  ~   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
  -->
<div ng-include="'/competences/public/template/enseignants/informations/display_construction_page.html'"></div>
<div class="row">
    <header>
        <!--<h1 style="float: left;">Relevé de notes</h1>-->
        <nav class="right-magnet nav-releve">
            <a class="button noMarginLeft twelve-mobile" ng-show="!isChefEtab()" href="/competences#/devoir/create">
                <i18n>evaluations.test.new</i18n>
            </a>
            <a class="button noMarginLeft twelve-mobile" ng-show="isChefEtab()" ng-click="displayInConstruction();">
                <i18n>evaluations.test.new</i18n>
            </a>
            <a class="button twelve-mobile" href="#/devoirs/list">
                <i18n>evaluations.test.list</i18n>
            </a>
        </nav>
    </header>

    <div class="twelve cell">
        <aside class="two cell twelve-mobile left">
            <div class="criteres card criterion" ng-class="{opened : opened.criteres === true}">
                <span class="plus-input" ng-click="openLeftMenu('opened.criteres', opened.criteres);"></span>
                <div class="header" ng-click="openLeftMenu('opened.criteres', opened.criteres);">
                    <h2>
                        <i18n>viescolaire.utils.criterion</i18n>
                    </h2>
                </div>
                <section ng-if="evaluations.structures.all.length > 1">
                    <label class="select">
                        <select ng-model="evaluations.structure"
                                ng-options="structure.libelle for structure in evaluations.structures.all track by structure.id"
                                ng-change="changeEtablissement()"></select>
                    </label>
                </section>
                <section>
                    <label class="select">
                        <select ng-model="search.periode"
                                ng-change="getReleve()"
                                ng-options="getI18nPeriode(periode) for periode in filteredPeriode | orderBy:'-type'">
                            <option disabled value="" class="header-opt">[[translate('viescolaire.utils.periode')]]
                            </option>
                        </select>
                    </label>
                </section>
                <section>
                    <label class="select">
                        <select ng-model="search.classe"
                                ng-change="getReleve(); syncPeriode(search.classe.id);"
                                ng-options="classe as classe.name group by classe.type_groupe_libelle for classe in classes.all | orderBy:['type_groupe_libelle','name']">
                            <option value="" class="header-opt">[[translate('viescolaire.utils.class.groupe')]]</option>
                        </select>
                    </label>
                </section>
                <section>
                    <label class="select">
                        <select ng-model="search.matiere" ng-change="getReleve()"
                                ng-init="initDefaultMatiere()"
                                ng-options="matiere.name for matiere in matieres.all|unique:'name'">
                            <option value="" class="header-opt">[[translate('viescolaire.utils.subject')]]</option>
                        </select>
                    </label>
                </section>

            </div>
            <div class="marginFive fiche left card" ng-if="search.periode.id !== null && search.periode.id !== undefined && showInfosEval">
                <container template="leftSide-devoirInfo"></container>
            </div>

            <div ng-if="!template.isEmpty('leftSide-userInfo') && showInfosEleve"
                 class="marginFive fiche student-info card left"
                 ng-class="{opened : openedStudentInfo === true}">
                <span class="plus-input" ng-click="openLeftMenu('openedStudentInfo', openedStudentInfo);"></span>
                <container template="leftSide-userInfo"></container>
            </div>

            <div class="criteres card criterion"
                 ng-show="search.periode.id !== undefined && search.classe.id !== undefined && search.matiere.id !== undefined && search.periode.type !== 0 && releveNote !== undefined"
                 ng-class="{openedProgramme : opened.elementProgramme === true}">
                <span class="plus-input" ng-click="openElementProgramme()"></span>
                <div class="header" ng-click="openElementProgramme();">
                    <h2>
                        <i18n>viescolaire.utils.elements.programme</i18n>
                    </h2>
                </div>
                <section
                        ng-if="releveNote.elementProgramme !== undefined && releveNote.elementProgramme.texte !== undefined ">
                    [[elementProgrammeDisplay]]
                </section>
                <BR/>
                <div class="right-magnet">
                    <a class="button noMarginLeft" ng-click="openEditElementProgramme()" ng-disabled="disabledSaisieNNoutPeriode()">
                        <i18n ng-if='elementProgrammeDisplay === undefined || elementProgrammeDisplay === "" '>evaluations.add</i18n>
                        <i18n ng-if='elementProgrammeDisplay !== undefined && elementProgrammeDisplay !== "" '>evaluations.edit</i18n>
                    </a>
                </div>
            </div>

            <div class="criteres card criterion"
                 ng-show="search.periode.id !== undefined && search.classe.id !== undefined && search.matiere.id !== undefined && search.periode.type !== 0 && releveNote !== undefined"
                 ng-class="{openedAppreciation : opened.appreciation === true}">
                <span class="plus-input" ng-click="openAppreciation();"></span>
                <div class="header" ng-click="openAppreciation();">
                    <h2>
                        <i18n>evaluations.releve.appreciation.classe</i18n>
                    </h2>
                </div>
                <ng-form name="appreciationClassForm">
                            <textarea placeholder="[[translate('evaluations.releve.appreciation.classe.placeholder')]]"
                                      row="4" type="text"
                                      ng-model="releveNote.appreciationClasse.appreciation"
                                      class="twelve"
                                      ng-class="{appreciationTextarea : opened.appreciation === true}"
                                      ng-maxlength="300"
                                      maxlength="300"
                                      ng-blur="releveNote.appreciationClasse.save()"
                                      ng-disabled="releveNote.appreciationClasse.endSaisie && !isChefEtab(search.classe)"
                                      name="appreciationClasse"
                            >
                            </textarea>
                    <div ng-if="appreciationClassForm.appreciationClasse.$error.maxlength" class="warning">
                        <i18n>evaluations.releve.appreciation.classe.max.length</i18n>
                    </div>
                </ng-form>

            </div>
        </aside>

        <section class="ten twelve-mobile cell right">

            <content ng-show="releveNote.synchronized.releve == true && releveNote !== undefined">
                <div class="tableReleves">
                    <div class="responsive-table">
                        <table class="list-view tableReleve tableRelevePadding marginTopZero"
                               c-naviga-table ng-if="search.periode.id !== null && search.periode.id !== undefined">
                            <thead>
                            <tr>
                                <th class="col1">
                                    <i18n>student</i18n>

                                    <span data-ng-click="toogleDevoirNote();"
                                          tooltip="[[releveNote.toogle ? 'evaluations.releve.note.show' : 'evaluations.releve.note.hide']]"
                                          class="toogleDevoir">
                                        <i ng-class="{'angle-double-right': !releveNote.toogle,'angle-double-left': releveNote.toogle}"
                                           class="toogleIcon"></i>
                                    </span>
                                </th>
                                <th class="colDevoir"
                                    ng-class="{'devoir-with-comp' : devoir.nbcompetences > 0, 'ellipsis' : true}"
                                    ng-repeat="devoir in releveNote.devoirs.all" ng-click="getDevoirInfo(devoir)"
                                    ng-dblclick="goTo('/devoir/'+devoir.id)">
                                    [[devoir.name]]
                                </th>
                                <th class="colMoyenne">
                                    <i18n>average.auto.min</i18n>
                                </th>
                                <th class="colMoyenne">
                                    <i18n>average.final.min</i18n>
                                </th>
                                <th class="colMoyenne"
                                    ng-class="{widthMax: releveNote.toogle}"
                                >
                                    <i18n>viescolaire.utils.appreciation</i18n>
                                </th>
                            </tr>
                            </thead>
                            <tbody ng-class="{maxHeight: releveNote.toogle || releveNote.isNN}">
                            <tr ng-repeat="eleve in releveNote.classe.eleves.all">
                                <td class="col1 text-overflow"
                                    ng-class="{'deletedStudent': eleve.deleteDate !== null}"
                                    ng-click="getEleveInfo(eleve)">
                                    [[::eleve.lastName]] [[::eleve.firstName]]
                                </td>
                                <td ng-class="{'nav-input' : evaluation.is_evaluated}" class="colDevoir"
                                    ng-repeat="evaluation in eleve.evaluations.all"
                                    data-label="[[getLibelleDevoir(evaluation.id_devoir)]]" >
                                    <input ng-if="evaluation.is_evaluated && evaluation.endSaisie && !isChefEtab(search.classe) && !evaluation.is_annotation"
                                           ng-focus="focusMe($event); getEleveInfo(eleve); getDevoirInfo(evaluation)"
                                           class="input-note"
                                           type="text"
                                           ng-model="evaluation.valeur"
                                           ng-disabled="true"
                                           max="20" min="0" step="0.01">
                                    <input ng-if="evaluation.is_evaluated && (!evaluation.endSaisie || isChefEtab(search.classe)) && !evaluation.is_annotation"
                                           ng-focus="focusMe($event); getEleveInfo(eleve); getDevoirInfo(evaluation)"
                                           class="input-note"
                                           type="text"
                                           ng-model="evaluation.valeur"
                                           ng-blur="saveNoteDevoirEleve(evaluation, $event, eleve)"
                                           ng-disabled="false"
                                           max="20" min="0" step="0.01">
                                    <input ng-if="!evaluation.is_evaluated && !evaluation.is_annotation"
                                           class="input-note"
                                           type="text"
                                           ng-disabled="true"
                                           max="20" min="0" step="0.01">
                                    <input ng-if="evaluation.is_annotation"
                                           class="input-note"
                                           ng-model="evaluation.annotation_libelle_court"
                                           type="text"
                                           ng-disabled="true"
                                           max="20" min="0" step="0.01">
                                </td>
                                <!--ng-init="initNoteReleve(evaluation)"-->
                                <td class="colMoyenne" data-label="[[translate('average.auto')]]">
                                    <span style="font-weight: bold;">[[eleve.moyenne]]</span>
                                </td>
                                <td class="colMoyenne"
                                    ng-init="initMoyenneFinale(eleve)"
                                    data-label="[[translate('average.final')]]">
                                    <input ng-focus="focusMe($event); getEleveInfo(eleve);"
                                           class="input-note"
                                           ng-class="{changedAverage: eleve.moyenneFinaleIsSet}"
                                           type="text"
                                           ng-disabled="disabledSaisieMoyenne()"
                                           ng-blur="saveMoyenneFinaleEleve(eleve,false)"
                                           ng-model="eleve.moyenneFinale"
                                           max="20" min="0" step="0.01">
                                </td>
                                <td class="colMoyenne size"
                                    ng-class="{widthMax: releveNote.toogle}"
                                    data-label="[[translate('viescolaire.utils.appreciation')]]">
                                    <form name="form"
                                          ng-class="{eleven: releveNote.toogle}"
                                          style="float: left">
                                        <textarea rows="2" cols="200"
                                                  name="appreciation"
                                                  class="eleven input-appreciation textarea-appreciation"
                                                  name="appreciation"
                                                  ng-model="eleve.appreciation_matiere_periode"
                                                  ng-disabled = "disabledSaisieNNoutPeriode()"
                                                  ng-blur="saveAppreciationMatierePeriodeEleve(eleve,true)"
                                                  ng-maxlength="MAX_CHAR_APPRECIATION_LENGTH"
                                                  maxlength="[[MAX_CHAR_APPRECIATION_LENGTH]]"
                                                  ng-focus="focusMe($event);getEleveInfo(eleve);">
                                        </textarea>
                                    </form>
                                    <i class="pencil"
                                       tooltip="[[translate('viescolaire.utils.appreciation.edit')]]"
                                       ng-click="openedLigthboxEleve(eleve, filteredPeriode);">
                                    </i>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                        <table class="list-view tableReleve tableRelevePadding marginTopZero" c-naviga-table ng-if="search.periode.id === null ">
                            <thead>
                            <tr>
                                <th class="col1">
                                    <i18n>student</i18n>
                                </th>
                                <th class="colMoyenne" ng-repeat="periode in filteredPeriode | orderBy:'-type'">
                                   [[getI18nPeriode(periode)]]
                                </th>
                                <th class="colMoyenne">
                                    &nbsp;
                                </th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr ng-repeat="eleve in releveNote.classe.eleves.all">
                                <td class="col1 text-overflow"
                                    ng-class="{'deletedStudent': eleve.deleteDate !== null}"
                                    ng-click="getEleveInfo(eleve)">
                                    [[eleve.lastName]] [[eleve.firstName]]
                                </td>
                                <td class="colMoyenne" ng-repeat="periode in filteredPeriode | orderBy:'-type'"
                                    ng-class="{changedAverage: hasMoyenneFinale(periode.id, eleve.moyennesFinales)}">
                                    [[getMoyenne(periode.id,eleve.moyennes, eleve.moyennesFinales)]]
                                </td>
                                <td class="colMoyenne">
                                    <i class="pencil"
                                       tooltip="[[translate('viescolaire.utils.appreciation.view')]]"
                                       ng-click="openedLigthboxEleve(eleve, filteredPeriode);">
                                    </i>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="responsive-table" ng-if="search.periode.id !== null && search.periode.id !== undefined">
                        <table id="tableReleveStats" ng-show="!releveNote.isNN && !releveNote.toogle" class="tableReleve tableRelevePadding" c-naviga-table>
                            <tbody>
                            <tr class="moyenneClasse">
                                <td class="col1 text-overflow">
                                    <i18n>viescolaire.classe.moyenne</i18n>
                                </td>
                                <td class="colDevoir" ng-repeat="devoir in releveNote.devoirs.all"
                                    data-label="[[devoir.name]]">
                                    <div ng-if="devoir.is_evaluated" class="input-note input-moyenne">
                                        [[devoir.statistiques.moyenne]]
                                    </div>
                                    <input ng-if="!devoir.is_evaluated"
                                           class="input-note"
                                           type="text"
                                           ng-disabled="true"
                                           max="20" min="0" step="0.01">
                                </td>
                                <td class="colMoyenne zero-mobile" data-label="Moyenne"></td>
                                <td class="colMoyenne zero-mobile" data-label="Moyenne"></td>
                                <th class="colMoyenne"
                                    ng-class="{widthMax: releveNote.toogle}"
                                ></th>
                            </tr>
                            <tr class="minClasse">
                                <td class="col1 text-overflow">
                                    <i18n>viescolaire.classe.note.min</i18n>
                                </td>
                                <td class="colDevoir"
                                    ng-repeat="devoir in releveNote.devoirs.all" data-label="[[devoir.name]]">
                                    <div ng-if="devoir.is_evaluated" class="input-note input-moyenne">
                                        [[devoir.statistiques.noteMin]]
                                    </div>
                                    <input ng-if="!devoir.is_evaluated"
                                           class="input-note"
                                           type="text"
                                           ng-disabled="true"
                                           max="20" min="0" step="0.01">
                                </td>
                                <td class="colMoyenne zero-mobile" data-label="Moyenne"></td>
                                <td class="colMoyenne zero-mobile" data-label="Moyenne"></td>
                                <th class="colMoyenne"
                                    ng-class="{widthMax: releveNote.toogle}"
                                ></th>
                            </tr>
                            <tr class="maxClasse">
                                <td class="col1 text-overflow">
                                    <i18n>viescolaire.classe.note.max</i18n>
                                </td>
                                <td class="colDevoir" ng-repeat="devoir in releveNote.devoirs.all"
                                    data-label="[[devoir.name]]">
                                    <div ng-if="devoir.is_evaluated" class="input-note input-moyenne">
                                        [[devoir.statistiques.noteMax]]
                                    </div>
                                    <input ng-if="!devoir.is_evaluated"
                                           class="input-note"
                                           type="text"
                                           ng-disabled="true"
                                           max="20" min="0" step="0.01">
                                </td>
                                <td class="colMoyenne zero-mobile" data-label="Moyenne"></td>
                                <td class="colMoyenne zero-mobile" data-label="Moyenne"></td>
                                <th class="colMoyenne"
                                    ng-class="{widthMax: releveNote.toogle}"
                                ></th>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </content>
            <content ng-show="search.periode.id !== null && releveNote === undefined">
                <article class="card tableReleves">
                    <i18n>evaluations.no.summary</i18n>
                    .
                </article>
            </content>
        </section>

    </div>

</div>
<lightbox show="releveNote.openedLightboxEleve" on-close="releveNote.openedLightboxEleve=false">
    <container template="lightboxEleveContainer"></container>
</lightbox>

<lightbox show="opened.lightboxReleve" on-close="opened.lightboxReleve=false"
          class="enLargedLightBox">
    <container template="lightboxContainerReleve"></container>
</lightbox>