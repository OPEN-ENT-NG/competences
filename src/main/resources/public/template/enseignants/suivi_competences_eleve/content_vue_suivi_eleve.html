<!--
  ~ Copyright (c) Région Hauts-de-France, Département 77, CGI, 2016.
  ~
  ~ This file is part of OPEN ENT NG. OPEN ENT NG is a versatile ENT Project based on the JVM and ENT Core Project.
  ~
  ~ This program is free software; you can redistribute it and/or modify
  ~ it under the terms of the GNU Affero General Public License as
  ~ published by the Free Software Foundation (version 3 of the License).
  ~ For the sake of explanation, any module that communicate over native
  ~ Web protocols, such as HTTP, with OPEN ENT NG is outside the scope of this
  ~ license and could be license under its own terms. This is merely considered
  ~ normal use of OPEN ENT NG, and does not fall under the heading of "covered work".
  ~
  ~ This program is distributed in the hope that it will be useful,
  ~ but WITHOUT ANY WARRANTY; without even the implied warranty of
  ~ MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
  ~
  -->
<div class="cell ng-scope twelve vertical-spacing">
    <label>
        <div class="cell cell-check expandable-content two-mobile">
            <label class="checkbox">
                <input type="checkbox" ng-model="selected.grey" class="ng-valid ng-dirty">
                <span></span>
            </label>
        </div>
        <i18n>evaluation.suivieleve.filtre.competence</i18n>
    </label>
    <button ng-click="opened.releveComp = true"
            style="position: absolute; right: 0; top: 0;"
            tooltip="evaluations.export.releveComp">
        <i class="download"></i>
    </button>
</div>


<script type="text/ng-template"  id="tree_item_renderer.html">

    <h4 ng-class="{'openedDom' : domaine.OpenDom, 'Domaine' : domaine.competences.all.length > 0 }" class="margin-top-1em twelve cell " ng-if="domaine.niveau === 1" ng-click="domaine.OpenDom = !domaine.OpenDom" ng-init="domaine.OpenDom = false">[[domaine.codification]] - [[domaine.libelle]]</h4>
    <div ng-class="{'openedSectionDom' : domaine.OpenDom}" ng-if="domaine.competences.all.length > 0" class="twelve cell" style='height: auto;'>

        <h3 ng-class="{'openedDom' : domaine.OpenSousDom}" class="margin-top-1em Domaine" ng-if="domaine.niveau > 1 && domaine.competences.all.length > 0" ng-click="domaine.OpenSousDom = !domaine.OpenSousDom" ng-init="domaine.OpenSousDom = false">[[domaine.codification]] - [[domaine.libelle]]</h3>
        <div ng-class="{'margin-top-1em' : domaine.competences.length > 0, 'openedSectionDom' : domaine.OpenSousDom}" style='height: auto;'>

            <div class="suivi-eleve-item competence-line" ng-click="openDetailCompetence(competence)" ng-repeat="competence in domaine.competences.all| filter:FilterNotEvaluated">

                <div tooltip="[[competence.nom]]" class="six inline-block ellipsis competence">
                    [[competence.nom]]
                </div>
                <div class="two inline-block align-center align-top">
                    <span ng-repeat="evaluation in competence.competencesEvaluations|filter:isMaxEvaluation(competence.competencesEvaluations)|limitTo:1"
                          tabindex="0">
                        <c-skills-bubble text="(mapLettres[evaluation.evaluation])"
                                         color="(mapCouleurs[evaluation.evaluation])"
                                         classes="'competence-eval alignVertical'">
                        </c-skills-bubble>
                    </span>
                    <span class="competence-eval rounded grey" ng-if="competence.competencesEvaluations.length < 1 || notEvalutationOwner(competence.competencesEvaluations)">
                    </span>
                </div>
                <div class="three inline-block align-center align-top">
                    <proportion-suivi-competence evaluations="competence.competencesEvaluations"
                                                 filter="suiviFilter" user="me"
                                                 is-classe="false"
                                                 map-couleurs="mapCouleurs"
                                                 map-lettres="mapLettres">

                    </proportion-suivi-competence>
                </div>

            </div>
        </div>
    </div>

    <div ng-repeat="domaine in domaine.domaines.all" ng-include="'tree_item_renderer.html'">
    </div>
</script>

<div ng-repeat="domaine in suiviCompetence.domaines.all" ng-include="'tree_item_renderer.html'">
</div>

<lightbox show="opened.releveComp" on-close="opened.releveComp = false; exportRelCompObj.errExport = false;">
    <h2>
        <i18n>evaluations.export.format.pdf</i18n>
    </h2>
    <div class="row">
        <div class="twelve cell twelve-mobile">
            <label class=" six select">
                <select ng-model="releveComp.periode"
                        ng-init="releveComp.periode=search.periode"
                        ng-change="exportRelCompObj.errExport = false;"
                        ng-options="periode as getI18nPeriode(periode) for periode in search.classe.periodes.all track by periode.id ">
                    <option class="header-opt" disabled value="">[[translate('viescolaire.utils.periode')]]</option>
                </select>
            </label>
        </div>
        <div class="twelve cell twelve-mobile">
            <label class="six select">
                <select ng-model="releveComp.matiere"
                        ng-options="matiere as matiere.name for matiere in matieres.all|unique:'name'"
                ng-change="exportRelCompObj.errExport = false;">
                    <option value="" class="header-opt">[[translate('viescolaire.utils.subject')]]</option>
                </select>
            </label>
        </div>
    </div>
    <div class="row">
        <div class="two cell">
            <label class="checkbox">
                <input type="checkbox"
                       ng-model="releveComp.textMod">
                <span><i18n>evaluation.devoir.cartouche.couleur</i18n></span>
            </label>
        </div>
    </div>
        <div class="row">
        <div class="warning"
             ng-if="exportRelCompObj.errExport">
            <i18n>evaluations.export.err</i18n>
        </div>
        <button class="right-magnet"
                ng-disabled = "releveComp.matiere.id === undefined || releveComp.matiere === null"
                tooltip="evaluations.export.format.pdf"
                ng-click="exportReleveComp(informations.eleve.id, releveComp.matiere.id, releveComp.periode.id_type, !releveComp.textMod)">
            <i18n>evaluations.export</i18n>
        </button>
    </div>
</lightbox>
